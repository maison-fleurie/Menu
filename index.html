<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu ‚Äì Maison Fleurie</title>
  <meta name="description" content="Menu de Maison Fleurie ‚Äî D√©guster, Cocktails, Vins. Imprimable et installable (PWA)." />
  <meta name="theme-color" content="#0B0B0B" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Viaoda+Libre:wght@400&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --vert-fond:#0B0B0B;
      --beige-logo:#B79A6B;
      --blanc:#FFFFFF;
      --beige-clair:#F3EFE6;
      --vert-accent:#214432;
      --or-accent:#D6C08F;
      --gris-texte:#4B4B44;
      --ombre-douce:rgba(0,0,0,.10);
      --ombre-forte:rgba(0,0,0,.25);
      --gradient-warm:linear-gradient(135deg,#B79A6B 0%,#D6C08F 50%,#E7D7AC 100%);
      --gradient-cool:linear-gradient(135deg,#0B0B0B 0%,#214432 60%,#2E5A45 100%);
      --shadow-modern:0 8px 32px rgba(0,0,0,.18);
      --shadow-elevated:0 16px 64px rgba(0,0,0,.28);
      --radius-lg:24px;--radius-md:16px
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--gradient-warm);color:var(--vert-fond);min-height:100vh;line-height:1.6}
    header.header{position:relative;text-align:center;background:var(--gradient-cool);color:var(--beige-logo);padding:3rem 1rem 2rem;box-shadow:var(--shadow-elevated);border-bottom:1px solid rgba(255,255,255,.08)}
    .header-title{font-family:'Viaoda Libre',serif;display:flex;align-items:center;justify-content:center;gap:1.2rem;margin:0;font-size:2.6rem;font-weight:400;letter-spacing:4px}
    .header-subtitle{margin:.75rem 0 0;font-size:1.1rem;letter-spacing:1.5px;color:var(--or-accent)}
    .search-container{margin:1.5rem auto .3rem;max-width:960px;padding:0 1rem}
    .search-row{display:flex;gap:.5rem}
    .search-box{flex:1;padding:1rem 1.2rem;border-radius:18px;border:2px solid transparent;background:#fff;box-shadow:var(--shadow-modern);color:var(--vert-fond)}
    .clear-btn{border:2px solid var(--beige-logo);background:#fff;border-radius:14px;padding:.8rem 1rem;cursor:pointer}
    .search-results-info{font-size:1rem;color:var(--vert-fond);margin:.8rem auto 0;font-weight:600;text-align:center;padding:.6rem 1rem;background:rgba(255,255,255,.9);border-radius:12px;box-shadow:var(--shadow-modern);max-width:960px}
    .action-bar{position:sticky;top:70px;z-index:9;max-width:960px;margin:.6rem auto 1rem;display:flex;gap:.6rem;justify-content:center;padding:0 1rem}
    .action-btn{background:#fff;border:2px solid var(--beige-logo);padding:.7rem 1rem;border-radius:14px;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .action-btn.primary{background:var(--gradient-cool);color:var(--beige-logo);border-color:var(--or-accent)}
    main.container{max-width:980px;margin:1rem auto 3rem;background:rgba(255,255,255,.98);border-radius:var(--radius-lg);box-shadow:var(--shadow-elevated);overflow:hidden;border:1px solid rgba(0,0,0,.08)}
    nav.tab-nav{display:flex;flex-wrap:wrap;justify-content:center;background:linear-gradient(135deg,var(--beige-clair) 0%,rgba(255,255,255,.95) 100%);border-bottom:2px solid var(--vert-fond);gap:.6rem;padding:1rem;position:sticky;top:0;z-index:8}
    .tab-btn{background:#fff;border:2px solid var(--beige-logo);padding:.85rem 1.1rem;font-size:1rem;cursor:pointer;font-weight:600;color:var(--vert-fond);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .tab-btn[aria-selected="true"]{background:var(--gradient-cool);color:var(--beige-logo);border-color:var(--or-accent);box-shadow:0 8px 24px rgba(0,0,0,.20)}
    .tab-content{display:none;padding:1.8rem 1.4rem;background:#fff;min-height:420px}
    .tab-content.active{display:block}
    .menu-item{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;padding:1rem;border-bottom:1px solid rgba(0,0,0,.06);background:linear-gradient(135deg,rgba(248,246,240,.4) 0%,rgba(255,255,255,.8) 100%);border-radius:12px}
    .menu-item + .menu-item{margin-top:.7rem}
    .item-info{flex:1;min-width:0}
    .item-name{font-size:1.1rem;font-weight:700;color:var(--vert-fond);letter-spacing:.3px}
    .item-section{font-size:.78rem;color:var(--gris-texte);margin:.2rem 0 .4rem;font-weight:700;text-transform:uppercase;letter-spacing:1.1px;opacity:.85}
    .item-description{font-size:.96rem;color:var(--gris-texte);font-style:italic;margin-top:.15rem}
    .item-price{font-size:1.02rem;color:var(--vert-fond);font-weight:800;background:var(--gradient-warm);border-radius:11px;padding:.45rem .7rem;min-width:84px;text-align:center}
    .section-title{font-family:'Viaoda Libre',serif;font-size:1.55rem;color:var(--vert-fond);margin:1.6rem 0 .9rem;text-align:center;letter-spacing:1.2px;position:relative}
    .section-title::after{content:'';position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:80px;height:4px;background:var(--gradient-warm);border-radius:2px}
    .now-title{font-size:1.25rem;font-family:'Viaoda Libre',serif;color:var(--vert-accent);margin:.6rem 0 .8rem;text-align:center}
    .empty-state{text-align:center;color:var(--gris-texte);margin:2rem 0;padding:1.8rem 1.2rem;background:linear-gradient(135deg,rgba(248,246,240,.3) 0%,rgba(255,255,255,.5) 100%);border-radius:18px;border:1px solid rgba(0,0,0,.06)}
    .skeleton{display:block;height:16px;background:linear-gradient(90deg,#eee,#f7f7f7,#eee);border-radius:8px;animation:sheen 1.6s infinite}
    .skeleton.big{height:22px}@keyframes sheen{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
    .badges{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.35rem}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .55rem;border-radius:999px;font-size:.72rem;font-weight:800;letter-spacing:.3px;border:1px solid rgba(0,0,0,.08);box-shadow:0 2px 8px var(--ombre-douce)}
    .badge-new{background:rgba(214,192,143,.22);color:#6a4c12}
    .badge-hit{background:rgba(183,154,107,.18);color:#5a4a2a}
    .badge-na{background:rgba(33,68,50,.14);color:#214432;border-color:#21443233}
    .filters{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;margin:0 0 1rem}
    .filters .filter{display:flex;align-items:center;gap:.4rem;background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.08);padding:.5rem .7rem;border-radius:12px}
    .filters select{border:1px solid rgba(0,0,0,.1);border-radius:10px;padding:.45rem .6rem;background:#fff}
    .filters .reset{margin-left:auto}
    .offline{position:fixed;bottom:14px;right:14px;background:#111;color:#fff;padding:.5rem .75rem;border-radius:999px;font-size:.85rem;box-shadow:0 8px 24px rgba(0,0,0,.25);display:none}
    .offline.show{display:flex;align-items:center;gap:.5rem}
    @media (max-width:768px){.menu-item{flex-direction:column}.item-price{align-self:flex-end}}
    @media print{
      body{background:#fff !important;color:#000 !important}
      header.header,.tab-nav,.search-container,.action-bar,#errorContainer{display:none !important}
      main.container{box-shadow:none;border:none;margin:0;max-width:100%;padding:0}
      .tab-content{display:block !important}
      .menu-item{page-break-inside:avoid;background:#fff !important;border:0;padding:.6rem 0}
      .item-price{background:none !important;color:#000 !important;border:1px solid #000}
    }
  </style>
</head>
<body>
  <a href="#main" class="sr-only">Aller au contenu</a>
  <header class="header" role="banner">
    <h1 class="header-title">MAISON FLEURIE</h1>
    <p class="header-subtitle">Table des Mets ‚Ä¢ Cocktails ‚Ä¢ Vins</p>
  </header>

  <div class="search-container">
    <div class="search-row">
      <label for="searchBox" class="sr-only">Rechercher</label>
      <input id="searchBox" class="search-box" type="search" placeholder="üîç Rechercher‚Ä¶ (ex: mojito, tartare, sans alcool)" autocomplete="off" />
      <button id="clearSearch" class="clear-btn" aria-label="Effacer">‚úñ</button>
    </div>
    <div id="searchInfo" class="search-results-info" aria-live="polite" style="display:none"></div>
  </div>

  <div class="action-bar">
    <button class="action-btn primary" id="btnInstall" style="display:none">üì≤ Installer l'app</button>
    <button class="action-btn" id="btnPrint">üñ®Ô∏è Imprimer / PDF</button>
    <button class="action-btn" id="btnShare">üîó Partager</button>
    <a class="action-btn" id="btnReserve" href="tel:+33649591816">üìû R√©server</a>
  </div>

  <main id="main" class="container" role="main">
    <nav class="tab-nav" role="tablist" aria-label="Cat√©gories du menu">
      <button id="tab-now" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-now" data-tab="now">‚ú® En ce moment</button>
      <button id="tab-deguster" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-deguster" data-tab="deguster">üçΩÔ∏è D√©guster</button>
      <button id="tab-cocktails" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-cocktails" data-tab="cocktails">üç∏ Cocktails</button>
      <button id="tab-chaudes" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-chaudes" data-tab="chaudes">‚òï Chaudes</button>
      <button id="tab-bieres" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-bieres" data-tab="bieres">üç∫ Bi√®res</button>
      <button id="tab-softs" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-softs" data-tab="softs">ü•§ Softs</button>
      <button id="tab-vins" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-vins" data-tab="vins">üç∑ Vins</button>
    </nav>

    <section id="panel-now" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="tab-now"></section>
    <section id="panel-deguster" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-deguster"></section>
    <section id="panel-cocktails" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-cocktails"></section>
    <section id="panel-chaudes" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-chaudes"></section>
    <section id="panel-bieres" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-bieres"></section>
    <section id="panel-softs" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-softs"></section>
    <section id="panel-vins" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-vins"></section>

    <div id="errorContainer" class="empty-state" style="display:none">
      <h3>Oups ! Impossible de charger le menu</h3>
      <p>V√©rifiez votre connexion et r√©essayez.</p>
      <button id="retryBtn">üîÑ R√©essayer</button>
    </div>
  </main>

  <div id="offlineToast" class="offline">‚ö†Ô∏è Hors‚Äëligne</div>

  <script>
    // ====== Config ======
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1lgd-rGS2kLCn0yPtGMc7RyMDue-YERmKOjNT3QKgJ3Y/export?format=csv&gid=0';
    const CACHE_KEY = 'maison-fleurie-menu-cache-v2';
    const CACHE_AT = 'maison-fleurie-menu-cache-at';
    const CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

    // ====== State ======
    let allMenuData = [];
    let currentTab = 'now';
    let isSearching = false;
    let searchTimeout;
    let installPromptEvt = null;

    // ====== Utils ======
    const normalize = (s='') => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const tabIdFromOnglet = (s='') => normalize(s).replace(/\s/g,'');
    const yes = (v) => ['oui','yes','true','1','y'].includes(normalize(v));

    const formatPrice = (raw='') => {
      const str = String(raw).trim();
      if (!str) return '';
      if (/‚Ç¨|eur/i.test(str)) return str.replace('EUR','‚Ç¨');
      const num = Number(String(str).replace(',', '.'));
      if (!Number.isNaN(num)) {
        try { return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(num); }
        catch { /* ignore */ }
      }
      return str;
    };

    const byNameFR = (a,b) => (a?.Nom||'').localeCompare(b?.Nom||'', 'fr', {sensitivity:'base'});
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // ====== Rendering ======
    const panels = {
      now: qs('#panel-now'), deguster: qs('#panel-deguster'), cocktails: qs('#panel-cocktails'),
      chaudes: qs('#panel-chaudes'), bieres: qs('#panel-bieres'), softs: qs('#panel-softs'), vins: qs('#panel-vins')
    };

    const showSkeleton = (el) => {
      el.innerHTML = `
        <div class="now-title">Chargement‚Ä¶</div>
        <div class="menu-item"><span class="skeleton big" style="width:60%"></span><span class="skeleton" style="width:90px"></span></div>
        <div class="menu-item"><span class="skeleton big" style="width:40%"></span><span class="skeleton" style="width:90px"></span></div>
        <div class="menu-item"><span class="skeleton big" style="width:50%"></span><span class="skeleton" style="width:90px"></span></div>`;
    };

    const createItemHTML = (item, {showSection=false}={}) => {
      const section = item.Section && showSection ? `<div class="item-section">${item.Section}</div>` : '';
      const desc = item.Description ? `<div class="item-description">${item.Description}</div>` : '';
      const badges = [];
      if (yes(item['Nouveau']) || yes(item['En ce moment'])) badges.push('<span class="badge badge-new">Nouveau</span>');
      if (yes(item['Best-seller']) || yes(item['Bestseller'])) badges.push('<span class="badge badge-hit">Best‚Äëseller</span>');
      if (yes(item['Sans alcool']) || /sans\s*alcool/i.test(item?.Section||'')) badges.push('<span class="badge badge-na">Sans alcool</span>');
      const badgesHTML = badges.length ? `<div class="badges">${badges.join('')}</div>` : '';
      return `
        <div class="menu-item">
          <div class="item-info">
            <div class="item-name">${item.Nom || ''}</div>
            ${section}
            ${desc}
            ${badgesHTML}
          </div>
          <div class="item-price">${formatPrice(item.Prix || '')}</div>
        </div>`;
    };

    const renderNow = () => {
      const el = panels.now; if (!el) return;
      let html = `<div class="now-title">√Ä l'affiche en ce moment</div>`;
      const nowItems = allMenuData.filter(i => yes(i['En ce moment']));
      if (!nowItems.length){
        el.innerHTML = `<div class="empty-state"><h3>Aucune nouveaut√©</h3><p>Aucun plat ou boisson n'est mis en avant pour l'instant.</p></div>`;
        return;
      }
      const groups = new Map();
      for (const it of nowItems){ const key = it.Section || 'Autres'; if (!groups.has(key)) groups.set(key, []); groups.get(key).push(it); }
      for (const [section, items] of groups){
        html += `<h2 class="section-title">${section}</h2>`;
        items.sort(byNameFR).forEach(it => { html += createItemHTML(it); });
      }
      el.innerHTML = html;
    };

    const renderTab = (tabName) => {
      if (tabName === 'now') return renderNow();
      const el = panels[tabName]; if (!el) return;
      const tabItems = allMenuData.filter(i => tabIdFromOnglet(i.Onglet) === tabName);
      if (!tabItems.length){
        el.innerHTML = `<div class="empty-state"><h3>Section vide</h3><p>Aucun √©l√©ment dans cette cat√©gorie pour le moment.</p></div>`;
        return;
      }
      // Vins : filtres dynamiques
      el.innerHTML = '';
      if (tabName === 'vins'){
        const getSet = (key) => Array.from(new Set(tabItems.map(i=>i[key]).filter(Boolean))).sort();
        const couleurs = getSet('Couleur');
        const regions = getSet('R√©gion').concat(getSet('Region'));
        const millesimes = getSet('Mill√©sime').concat(getSet('Millesime'));
        if (couleurs.length || regions.length || millesimes.length){
          const filtersEl = document.createElement('div'); filtersEl.className='filters';
          filtersEl.innerHTML = `
            <div class="filter"><label>Couleur</label><select id="f-couleur"><option value="">Toutes</option>${couleurs.map(v=>`<option>${v}</option>`).join('')}</select></div>
            <div class="filter"><label>R√©gion</label><select id="f-region"><option value="">Toutes</option>${regions.map(v=>`<option>${v}</option>`).join('')}</select></div>
            <div class="filter"><label>Mill√©sime</label><select id="f-millesime"><option value="">Tous</option>${millesimes.map(v=>`<option>${v}</option>`).join('')}</select></div>
            <button class="action-btn reset" id="f-reset">R√©initialiser</button>`;
          el.appendChild(filtersEl);
          filtersEl.addEventListener('change', () => applyFilters());
          filtersEl.querySelector('#f-reset')?.addEventListener('click', () => { ['#f-couleur','#f-region','#f-millesime'].forEach(s=>{ const n=document.querySelector(s); if(n) n.value=''; }); applyFilters(); });
        }
        const listEl = document.createElement('div'); listEl.id='vins-list'; el.appendChild(listEl);
        const buildGroupedHTML = (items) => {
          const groups = new Map();
          for (const it of items){ const key = it.Section || 'Autres'; if (!groups.has(key)) groups.set(key, []); groups.get(key).push(it); }
          let html = '';
          for (const [section, items] of groups){
            html += `<h2 class="section-title">${section}</h2>`;
            items.sort(byNameFR).forEach(it => { html += createItemHTML(it); });
          }
          return html || `<div class="empty-state"><h3>Aucun vin</h3><p>Essayez d'autres filtres.</p></div>`;
        };
        const applyFilters = () => {
          const c = document.querySelector('#f-couleur')?.value || ''; const r = document.querySelector('#f-region')?.value || ''; const m = document.querySelector('#f-millesime')?.value || '';
          let items = tabItems;
          if (c) items = items.filter(i => (i.Couleur||'') === c);
          if (r) items = items.filter(i => (i['R√©gion']||i.Region||'') === r);
          if (m) items = items.filter(i => (i['Mill√©sime']||i.Millesime||'') === m);
          listEl.innerHTML = buildGroupedHTML(items);
        };
        listEl.innerHTML = buildGroupedHTML(tabItems);
        return;
      }
      // Autres onglets
      const groups = new Map();
      for (const it of tabItems){ const key = it.Section || 'Autres'; if (!groups.has(key)) groups.set(key, []); groups.get(key).push(it); }
      let html = '';
      for (const [section, items] of groups){
        html += `<h2 class="section-title">${section}</h2>`;
        items.sort(byNameFR).forEach(it => { html += createItemHTML(it); });
      }
      el.innerHTML = html;
    };

    const renderAll = () => {
      Object.values(panels).forEach(p => p && (p.innerHTML = ''));
      for (const key of Object.keys(panels)) renderTab(key);
    };

    // ====== Tabs interaction (A11y) ======
    const setActiveTab = (tabName) => {
      currentTab = tabName;
      qsa('.tab-btn').forEach(btn => {
        const active = btn.dataset.tab === tabName;
        btn.setAttribute('aria-selected', active ? 'true' : 'false');
        btn.tabIndex = active ? 0 : -1;
      });
      qsa('.tab-content').forEach(p => p.classList.remove('active'));
      qs(`#panel-${tabName}`)?.classList.add('active');
      if (isSearching) { displaySearchResults(lastSearchResults, lastQuery); } else { renderTab(tabName); }
    };

    const focusNextTab = (dir) => {
      const tabs = qsa('.tab-btn');
      const idx = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
      const next = (idx + dir + tabs.length) % tabs.length;
      tabs[next].focus();
      setActiveTab(tabs[next].dataset.tab);
    };

    // ====== Data ======
    const parseAndSet = (rows=[]) => {
      allMenuData = rows.filter(i => yes(i.Actif));
      renderAll();
      updateLastUpdateTag();
    };

    const loadFromCacheIfFresh = () => {
      try{
        const at = Number(localStorage.getItem(CACHE_AT)||0);
        if (Date.now() - at < CACHE_TTL_MS){
          const cached = JSON.parse(localStorage.getItem(CACHE_KEY)||'[]');
          if (Array.isArray(cached) && cached.length){ parseAndSet(cached); return true; }
        }
      }catch{}
      return false;
    };

    const saveCache = (rows) => {
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
        localStorage.setItem(CACHE_AT, String(Date.now()));
      }catch{}
    };

    const showError = () => { qs('#errorContainer').style.display = 'block'; };
    const hideError = () => { qs('#errorContainer').style.display = 'none'; };

    const fetchCSVAndRender = async () => {
      Object.values(panels).forEach(p => p && showSkeleton(p));
      if (loadFromCacheIfFresh()) return;
      let attempt = 0; const maxAttempts = 3;
      const backoff = (n) => new Promise(r => setTimeout(r, 400 * Math.pow(2, n)));
      while (attempt < maxAttempts){
        try{
          await new Promise((resolve, reject) => {
            Papa.parse(CSV_URL, {
              download: true,
              header: true,
              complete: (res) => {
                if (res.errors && res.errors.length){ reject(res.errors); return; }
                hideError();
                saveCache(res.data);
                parseAndSet(res.data);
                resolve();
              },
              error: (err) => reject(err)
            });
          });
          return; // success
        }catch(e){
          attempt++;
          if (attempt >= maxAttempts){ showError(); break; }
          await backoff(attempt);
        }
      }
    };

    // ====== Search ======
    let lastQuery = '';
    let lastSearchResults = [];

    const performSearch = (query) => {
      isSearching = true; lastQuery = query;
      const q = normalize(query);
      const results = allMenuData.filter(i =>
        normalize(i.Nom).includes(q) || normalize(i.Description).includes(q) || normalize(i.Section).includes(q)
      );
      lastSearchResults = results;
      displaySearchResults(results, query);
      const info = qs('#searchInfo');
      info.style.display = 'block';
      info.textContent = `${results.length} r√©sultat(s) pour "${query}"`;
    };

    const displaySearchResults = (results, query) => {
      const container = qs(`#panel-${currentTab}`);
      if (!results.length){
        container.innerHTML = `<div class="empty-state"><h3>Aucun r√©sultat</h3><p>Aucun plat ou boisson ne correspond √† "${query}".</p></div>`;
        return;
      }
      const byTab = new Map();
      for (const it of results){
        const tab = tabIdFromOnglet(it.Onglet) || 'autres';
        if (!byTab.has(tab)) byTab.set(tab, new Map());
        const bySec = byTab.get(tab);
        const sec = it.Section || 'Autres';
        if (!bySec.has(sec)) bySec.set(sec, []);
        bySec.get(sec).push(it);
      }
      let html = '';
      for (const [tab, secMap] of byTab){
        html += `<h2 class="section-title">${tab === 'now' ? 'En ce moment' : tab.charAt(0).toUpperCase()+tab.slice(1)}</h2>`;
        for (const [sec, items] of secMap){
          html += `<div class="now-title">${sec}</div>`;
          items.sort(byNameFR).forEach(it => { html += createItemHTML(it, {showSection:false}); });
        }
      }
      container.innerHTML = html;
    };

    const clearSearch = () => {
      isSearching = false; lastQuery=''; lastSearchResults=[];
      qs('#searchBox').value = '';
      const info = qs('#searchInfo'); info.style.display = 'none'; info.textContent = '';
      renderTab(currentTab);
      qs('#searchBox').focus();
    };

    // ====== PWA Setup & UI ======
    const setupPWA = () => {
      // SW register
      if ('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
      // Install prompt
      window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); installPromptEvt=e; const b=qs('#btnInstall'); if(b) b.style.display='inline-flex'; });
      qs('#btnInstall')?.addEventListener('click', async()=>{ if(!installPromptEvt) return; installPromptEvt.prompt(); try{await installPromptEvt.userChoice;}catch{} installPromptEvt=null; qs('#btnInstall').style.display='none'; });
    };

    const updateLastUpdateTag = () => {
      const at = Number(localStorage.getItem(CACHE_AT)||0);
      const info = qs('#searchInfo');
      if (info && at){ const d = new Date(at); info.title = 'Derni√®re maj du menu: '+ d.toLocaleString('fr-FR'); }
    };

    const init = () => {
      // tabs click
      qsa('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); setActiveTab(btn.dataset.tab); });
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowRight') { e.preventDefault(); focusNextTab(+1); }
          if (e.key === 'ArrowLeft')  { e.preventDefault(); focusNextTab(-1); }
          if (e.key === 'Home')       { e.preventDefault(); setActiveTab(qsa('.tab-btn')[0].dataset.tab); qsa('.tab-btn')[0].focus(); }
          if (e.key === 'End')        { const tabs=qsa('.tab-btn'); e.preventDefault(); setActiveTab(tabs[tabs.length-1].dataset.tab); tabs[tabs.length-1].focus(); }
        });
      });

      // search
      const searchBox = qs('#searchBox');
      const clearBtn = qs('#clearSearch');
      searchBox.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (!query){ clearSearch(); return; }
        searchTimeout = setTimeout(() => performSearch(query), 250);
      });
      clearBtn.addEventListener('click', clearSearch);

      // retry
      qs('#retryBtn').addEventListener('click', fetchCSVAndRender);

      // action bar
      qs('#btnPrint').addEventListener('click', () => window.print());
      qs('#btnShare').addEventListener('click', async () => {
        const url = location.href;
        if (navigator.share){ try{ await navigator.share({title:document.title,text:'Menu ‚Äì Maison Fleurie',url}); }catch{} }
        else { try{ await navigator.clipboard.writeText(url); alert('Lien copi√©'); }catch{} }
      });

      // offline toast
      const toggle = () => { qs('#offlineToast').classList.toggle('show', !navigator.onLine); };
      window.addEventListener('online', toggle); window.addEventListener('offline', toggle); toggle();

      setupPWA();
      fetchCSVAndRender();
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
